{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NIVAL IMPACT - Accueil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="container mt-4 bg-light">

    <!-- Titre principal -->
    <h1 class="mb-4">üè† Gestion Locative NIVAL IMPACT</h1>

         
    <!-- Boutons d'ajout -->
    <div class="mb-4">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProprietaire">‚ûï Ajouter un propri√©taire</button>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLocataire">‚ûï Ajouter un locataire</button>
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPaiement">üí∞ Enregistrer un paiement</button>
</div>

     
   

    <!-- Modal Ajouter Propri√©taire -->
    <div class="modal fade" id="modalProprietaire" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">‚ûï Ajouter un propri√©taire</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'ajouter_proprietaire' %}">
              {% csrf_token %}
              {{ proprietaire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-success">‚úÖ Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ajouter Locataire -->
    <div class="modal fade" id="modalLocataire" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">‚ûï Ajouter un locataire</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'ajouter_locataire' %}">
              {% csrf_token %}
              {{ locataire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  <!-- Modal Ajouter Paiement -->
<div class="modal fade" id="modalPaiement" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">üí∞ Enregistrer un paiement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="paiementForm" method="post">
          {% csrf_token %}

          <!-- Propri√©taire - Tri√© alphab√©tiquement -->
<div class="mb-3">
  <label for="select_proprietaire">Propri√©taire</label>
  <select name="proprietaire" id="select_proprietaire" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    <option value="">--- S√©lectionnez un propri√©taire ---</option>
    {% for proprietaire in proprietaires %}
      <option value="{{ proprietaire.id }}">{{ proprietaire.nom }}</option>
    {% endfor %}
  </select>
</div>

          <!-- Locataire -->
          <div class="mb-3">
            <label for="select_locataire">Locataire</label>
            <select name="locataire" id="select_locataire" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
              <option value="">--- Choisissez d'abord un propri√©taire ---</option>
            </select>
          </div>

          <!-- Montant -->
          <div class="mb-3">
            <label for="input_montant">Montant</label>
            <input type="number" name="montant" id="input_montant" step="0.01" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>

          <!-- Date de paiement -->
          <div class="mb-3">
            <label for="input_date">Date de paiement</label>
            <input type="date" name="date_paiement" id="input_date" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>

          <!-- Mois concern√© -->
<div class="mb-3">
  <label for="select_mois">Mois concern√©</label>
  <select name="mois_concerne" id="select_mois" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
    <option value="">---</option>
    <option value="1">Janvier</option>
    <option value="2">F√©vrier</option>
    <option value="3">Mars</option>
    <option value="4">Avril</option>
    <option value="5">Mai</option>
    <option value="6">Juin</option>
    <option value="7">Juillet</option>
    <option value="8">Ao√ªt</option>
    <option value="9">Septembre</option>
    <option value="10">Octobre</option>
    <option value="11">Novembre</option>
    <option value="12">D√©cembre</option>
  </select>
</div>

          <!-- Pay√© en avance -->
          <div class="mb-3">
            <label>
              <input type="checkbox" name="paye_en_avance" id="input_avance"> Pay√© en avance
            </label>
          </div>

          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-warning">‚úÖ Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-2"><strong>Propri√©taires :</strong> {{ proprietaires_count }}</div>
        <div class="col-md-2"><strong>Locataires :</strong> {{ locataires_count }}</div>
        <div class="col-md-3"><strong>Loyers totaux :</strong> {{ total_loyers }} FCFA</div>
        <div class="col-md-3"><strong>Loyers re√ßus :</strong> {{ total_recu }} FCFA</div>
        <div class="col-md-2"><strong>Commission :</strong> {{ commission }} FCFA</div>
    </div>
       
    <!-- Bouton pour afficher les non pay√©s avec compteur -->
<button class="btn btn-danger mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#nonPayesList">
  üìå Locataires non pay√©s ({{ non_payes_count }})
</button>



<div class="mb-4">
  <!-- Bouton voir paiements -->
  <a href="{% url 'liste_paiements' %}" class="btn btn-info me-2">
    üí∞ Voir les paiements
  </a>

  <!-- Bouton rapport global -->
  <a href="{% url 'rapport_global' %}" class="btn btn-primary me-2">
    üìä Rapport global
  </a>

  <!-- Bouton rapport global PDF -->
  <a href="{% url 'rapport_global_pdf' %}" class="btn btn-danger">
    üìÑ T√©l√©charger rapport global en PDF
  </a>
</div>


<!-- Liste des locataires non pay√©s (cach√©e par d√©faut) -->
<div class="collapse" id="nonPayesList">
  <h5>Locataires qui n'ont pas pay√© {% if mois %}pour le mois {{ mois }}{% endif %}</h5>
  <ul class="list-group">
    {% for item in locataires_non_payes %}
    <li class="list-group-item">
      <strong>Propri√©taire :</strong> {{ item.proprietaire.nom }}
      ‚Üí <strong>Locataire :</strong> {{ item.locataire.nom }} (üìû {{ item.locataire.numero }})
    </li>
    {% empty %}
    <li class="list-group-item">‚úÖ Tous les locataires ont pay√© ce mois</li>
    {% endfor %}
  </ul>
</div>

   

    
    <!-- Cartes des propri√©taires -->
<div class="row">
    {% for proprietaire in proprietaires %}
    <div class="col-md-4 mb-3">
        <div class="card shadow">
            <div class="card-body">
                <h5 class="card-title">{{ proprietaire.nom }}</h5>
                <p class="card-text">üìû {{ proprietaire.numero }}</p>

                <!-- Boutons d'action -->
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierProprietaire{{ proprietaire.id }}">‚úèÔ∏è Modifier</button>
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerProprietaire{{ proprietaire.id }}">üóë Supprimer</button>

                <button class="btn btn-outline-primary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#locataires{{ proprietaire.id }}">
                    Voir les locataires
                </button>

                <a href="{% url 'rapport_proprietaire' proprietaire.id %}" class="btn btn-outline-warning mt-2">
                          üìä Rapport mensuel
                 </a>

                 <a href="{% url 'rapport_proprietaire_pdf' proprietaire.id %}" class="btn btn-outline-danger mt-3">
                      üìÑ T√©l√©charger en PDF
                </a>


                <div class="collapse mt-2" id="locataires{{ proprietaire.id }}">
                      <ul class="list-group">
                         {% for locataire in proprietaire.locataires.all %}
                        <li class="list-group-item">
                    {{ locataire.nom }} - {{ locataire.numero }} - {{ locataire.loyer_mensuel }} FCFA
                      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierLocataire{{ locataire.id }}">‚úèÔ∏è</button>
                   <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerLocataire{{ locataire.id }}">üóë</button>
                    </li>
                   {% empty %}
                      <li class="list-group-item">Aucun locataire</li>
                     {% endfor %}
                       </ul>
                  </div>

            </div>
        </div>
    </div>

    <!-- Modal Modifier Propri√©taire -->
<div class="modal fade" id="modalModifierProprietaire{{ proprietaire.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚úèÔ∏è Modifier {{ proprietaire.nom }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'modifier_proprietaire' proprietaire.id %}">
          {% csrf_token %}
          
          <!-- ‚úÖ Champs pr√©-remplis -->
          <div class="mb-3">
            <label for="nom_{{ proprietaire.id }}" class="form-label">Nom</label>
            <input type="text" class="form-control" id="nom_{{ proprietaire.id }}" name="nom" value="{{ proprietaire.nom }}" required>
          </div>
          
          <div class="mb-3">
            <label for="numero_{{ proprietaire.id }}" class="form-label">Num√©ro</label>
            <input type="text" class="form-control" id="numero_{{ proprietaire.id }}" name="numero" value="{{ proprietaire.numero }}" required>
          </div>
          
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

    <!-- Modal Supprimer Propri√©taire -->
    <div class="modal fade" id="modalSupprimerProprietaire{{ proprietaire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">üóë Supprimer {{ proprietaire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'supprimer_proprietaire' proprietaire.id %}">
              {% csrf_token %}
              <p>Confirmer la suppression de <strong>{{ proprietaire.nom }}</strong> ?</p>
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-danger">üóë Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% for locataire in proprietaire.locataires.all %}
    <!-- Modal Modifier Locataire -->
<div class="modal fade" id="modalModifierLocataire{{ locataire.id }}" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">‚úèÔ∏è Modifier {{ locataire.nom }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'modifier_locataire' locataire.id %}">
          {% csrf_token %}
          
          <!-- ‚úÖ Champs pr√©-remplis -->
          <div class="mb-3">
            <label for="nom_loc_{{ locataire.id }}" class="form-label">Nom</label>
            <input type="text" class="form-control" id="nom_loc_{{ locataire.id }}" name="nom" value="{{ locataire.nom }}" required>
          </div>
          
          <div class="mb-3">
            <label for="numero_loc_{{ locataire.id }}" class="form-label">Num√©ro</label>
            <input type="text" class="form-control" id="numero_loc_{{ locataire.id }}" name="numero" value="{{ locataire.numero }}" required>
          </div>
          
          <div class="mb-3">
            <label for="loyer_loc_{{ locataire.id }}" class="form-label">Loyer mensuel</label>
            <input type="number" step="0.01" class="form-control" 
       id="loyer_loc_{{ locataire.id }}" 
       name="loyer_mensuel" 
       value="{{ locataire.loyer_mensuel }}" 
       required>
          </div>
          
          <div class="mb-3">
            <label for="proprietaire_loc_{{ locataire.id }}" class="form-label">Propri√©taire</label>
            <select class="form-select" id="proprietaire_loc_{{ locataire.id }}" name="proprietaire" required>
              {% for prop in proprietaires %}
                <option value="{{ prop.id }}" {% if prop.id == locataire.proprietaire.id %}selected{% endif %}>
                  {{ prop.nom }}
                </option>
              {% endfor %}
            </select>
          </div>
          
          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

    <!-- Modal Supprimer Locataire -->
    <div class="modal fade" id="modalSupprimerLocataire{{ locataire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">üóë Supprimer {{ locataire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'supprimer_locataire' locataire.id %}">
              {% csrf_token %}
              <p>Confirmer la suppression de <strong>{{ locataire.nom }}</strong> ?</p>
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-danger">üóë Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endfor %}
</div>



<script>
document.addEventListener("DOMContentLoaded", function() {
    const form = document.getElementById("paiementForm");
    const propSelect = document.getElementById("select_proprietaire");
    const locSelect = document.getElementById("select_locataire");
    const montantInput = document.getElementById("input_montant");
    
    // Fonction pour charger les locataires
    function chargerLocataires(proprietaireId) {
        if (!proprietaireId) {
            locSelect.innerHTML = '<option value="">--- Choisissez d\'abord un propri√©taire ---</option>';
            return;
        }
        
        fetch(`/get-locataires/${proprietaireId}/`)
          .then(r => r.json())
          .then(data => {
              locSelect.innerHTML = '<option value="">--- S√©lectionnez un locataire ---</option>';
              data.locataires.forEach(loc => {
                  locSelect.innerHTML += `<option value="${loc.id}">${loc.nom}</option>`;
              });
          });
    }
    
    // Charger locataires quand propri√©taire change
    propSelect.onchange = function() {
        chargerLocataires(this.value);
    };
    
    // Charger loyer quand locataire change
    locSelect.onchange = function() {
        if (!this.value) return;
        fetch(`/get-loyer/${this.value}/`)
          .then(r => r.json())
          .then(data => { montantInput.value = data.loyer || ""; });
    };
    
    // Soumission formulaire
    form.onsubmit = function(e) {
        e.preventDefault();
        fetch("{% url 'ajouter_paiement' %}", {
            method: "POST",
            body: new FormData(form),
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(r => r.json().then(data => ({status: r.status, data})))
        .then(({status, data}) => {
            if (status === 200 && data.success) {
                alert("‚úÖ Paiement enregistr√© avec succ√®s !");
                
                // ‚úÖ Recharger les locataires du propri√©taire actuellement s√©lectionn√©
                const proprietaireId = propSelect.value;
                chargerLocataires(proprietaireId);
                
                // ‚úÖ R√©initialiser le montant
                montantInput.value = "";
            } else {
                alert(data.errors?.__all__?.[0] || "‚ùå Erreur lors de l'enregistrement");
            }
        });
    };
});
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Correction imm√©diate au chargement ‚Äî avant toute ouverture de modal
document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll('input[type="number"]').forEach(function(input) {
        var raw = input.getAttribute('value');
        if (raw) {
            input.setAttribute('value', raw.replace(',', '.'));
            input.value = raw.replace(',', '.');
        }
    });
});
</script>

</body>
</html>
