{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NIVAL IMPACT - Accueil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="container mt-4 bg-light">

    <!-- Titre principal -->
    <h1 class="mb-4">ğŸ  Gestion Locative NIVAL IMPACT</h1>

         
    <!-- Boutons d'ajout -->
    <div class="mb-4">
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProprietaire">â• Ajouter un propriÃ©taire</button>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLocataire">â• Ajouter un locataire</button>
    <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPaiement">ğŸ’° Enregistrer un paiement</button>
</div>

     
   

    <!-- Modal Ajouter PropriÃ©taire -->
    <div class="modal fade" id="modalProprietaire" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">â• Ajouter un propriÃ©taire</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'ajouter_proprietaire' %}">
              {% csrf_token %}
              {{ proprietaire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-success">âœ… Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ajouter Locataire -->
    <div class="modal fade" id="modalLocataire" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">â• Ajouter un locataire</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'ajouter_locataire' %}">
              {% csrf_token %}
              {{ locataire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">âœ… Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  <!-- Modal Ajouter Paiement -->
<div class="modal fade" id="modalPaiement" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">ğŸ’° Enregistrer un paiement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="paiementForm" method="post">
          {% csrf_token %}

          <!-- PropriÃ©taire -->
<div class="mb-3">
  <label for="id_proprietaire" class="form-label">PropriÃ©taire</label>
  {{ paiement_form.proprietaire }}
  <button type="button" id="btn-filtrer" class="btn btn-secondary ms-2">Filtrer</button>
</div>

<!-- Locataire -->
<div class="mb-3">
  <label for="id_locataire" class="form-label">Locataire</label>
  {{ paiement_form.locataire }}
</div>

<!-- Montant -->
<div class="mb-3">
  <label for="id_montant" class="form-label">Montant</label>
  {{ paiement_form.montant }}
</div>

<!-- Date de paiement -->
<div class="mb-3">
  <label for="id_date_paiement" class="form-label">Date de paiement</label>
  {{ paiement_form.date_paiement }}
</div>

<!-- Mois concernÃ© -->
<div class="mb-3">
  <label for="id_mois_concerne" class="form-label">Mois concernÃ©</label>
  {{ paiement_form.mois_concerne }}
</div>

<!-- PayÃ© en avance -->
<div class="form-check mb-3">
  {{ paiement_form.paye_en_avance }}
  <label class="form-check-label" for="id_paye_en_avance">PayÃ© en avance</label>
</div>


          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-warning">âœ… Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<!-- Script AJAX -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    const paiementForm = document.getElementById("paiementForm");

    paiementForm.addEventListener("submit", function(e) {
        e.preventDefault(); // EmpÃªche le rechargement de la page

        const formData = new FormData(paiementForm);

        fetch("{% url 'ajouter_paiement' %}", {
            method: "POST",
            body: formData,
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            }
        })
        .then(response => {
            if (response.ok) {
                alert("âœ… Paiement enregistrÃ© avec succÃ¨s !");
                const modal = bootstrap.Modal.getInstance(document.getElementById("modalPaiement"));
                modal.hide();
                window.location.reload(); // recharge le tableau
            } else {
                alert("âŒ Erreur lors de l'enregistrement");
            }
        })
        .catch(err => console.error("Erreur AJAX :", err));
    });
});
</script>

    <!-- Filtre par mois -->
    <form method="get" class="mb-4">
        <label for="mois">Filtrer par mois :</label>
        <select name="mois" id="mois" class="form-select w-auto d-inline-block">
            <option value="">Tous</option>
            {% for i in mois_list %}
                <option value="{{ i }}" {% if mois == i|stringformat:"s" %}selected{% endif %}>{{ i }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filtrer</button>
    </form>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-2"><strong>PropriÃ©taires :</strong> {{ proprietaires_count }}</div>
        <div class="col-md-2"><strong>Locataires :</strong> {{ locataires_count }}</div>
        <div class="col-md-3"><strong>Loyers totaux :</strong> {{ total_loyers }} FCFA</div>
        <div class="col-md-3"><strong>Loyers reÃ§us :</strong> {{ total_recu }} FCFA</div>
        <div class="col-md-2"><strong>Commission :</strong> {{ commission }} FCFA</div>
    </div>
       
    <!-- Bouton pour afficher les non payÃ©s avec compteur -->
<button class="btn btn-danger mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#nonPayesList">
  ğŸ“Œ Locataires non payÃ©s ({{ non_payes_count }})
</button>



<div class="mb-4">
  <!-- Bouton voir paiements -->
  <a href="{% url 'liste_paiements' %}" class="btn btn-info me-2">
    ğŸ’° Voir les paiements
  </a>

  <!-- Bouton rapport global -->
  <a href="{% url 'rapport_global' %}" class="btn btn-primary me-2">
    ğŸ“Š Rapport global
  </a>

  <!-- Bouton rapport global PDF -->
  <a href="{% url 'rapport_global_pdf' %}" class="btn btn-danger">
    ğŸ“„ TÃ©lÃ©charger rapport global en PDF
  </a>
</div>


<!-- Liste des locataires non payÃ©s (cachÃ©e par dÃ©faut) -->
<div class="collapse" id="nonPayesList">
  <h5>Locataires qui n'ont pas payÃ© {% if mois %}pour le mois {{ mois }}{% endif %}</h5>
  <ul class="list-group">
    {% for item in locataires_non_payes %}
    <li class="list-group-item">
      <strong>PropriÃ©taire :</strong> {{ item.proprietaire.nom }}
      â†’ <strong>Locataire :</strong> {{ item.locataire.nom }} (ğŸ“ {{ item.locataire.numero }})
    </li>
    {% empty %}
    <li class="list-group-item">âœ… Tous les locataires ont payÃ© ce mois</li>
    {% endfor %}
  </ul>
</div>

   

    
    <!-- Cartes des propriÃ©taires -->
<div class="row">
    {% for proprietaire in proprietaires %}
    <div class="col-md-4 mb-3">
        <div class="card shadow">
            <div class="card-body">
                <h5 class="card-title">{{ proprietaire.nom }}</h5>
                <p class="card-text">ğŸ“ {{ proprietaire.numero }}</p>

                <!-- Boutons d'action -->
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierProprietaire{{ proprietaire.id }}">âœï¸ Modifier</button>
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerProprietaire{{ proprietaire.id }}">ğŸ—‘ Supprimer</button>

                <button class="btn btn-outline-primary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#locataires{{ proprietaire.id }}">
                    Voir les locataires
                </button>

                <a href="{% url 'rapport_proprietaire' proprietaire.id %}" class="btn btn-outline-warning mt-2">
                          ğŸ“Š Rapport mensuel
                 </a>

                 <a href="{% url 'rapport_proprietaire_pdf' proprietaire.id %}" class="btn btn-outline-danger mt-3">
                      ğŸ“„ TÃ©lÃ©charger en PDF
                </a>


                <div class="collapse mt-2" id="locataires{{ proprietaire.id }}">
                      <ul class="list-group">
                         {% for locataire in proprietaire.locataires.all %}
                        <li class="list-group-item">
                    {{ locataire.nom }} - {{ locataire.numero }} - {{ locataire.loyer_mensuel }} FCFA
                      <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierLocataire{{ locataire.id }}">âœï¸</button>
                   <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerLocataire{{ locataire.id }}">ğŸ—‘</button>
                    </li>
                   {% empty %}
                      <li class="list-group-item">Aucun locataire</li>
                     {% endfor %}
                       </ul>
                  </div>

            </div>
        </div>
    </div>

    <!-- Modal Modifier PropriÃ©taire -->
    <div class="modal fade" id="modalModifierProprietaire{{ proprietaire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">âœï¸ Modifier {{ proprietaire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'modifier_proprietaire' proprietaire.id %}">
              {% csrf_token %}
              {{ proprietaire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">âœ… Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Supprimer PropriÃ©taire -->
    <div class="modal fade" id="modalSupprimerProprietaire{{ proprietaire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">ğŸ—‘ Supprimer {{ proprietaire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'supprimer_proprietaire' proprietaire.id %}">
              {% csrf_token %}
              <p>Confirmer la suppression de <strong>{{ proprietaire.nom }}</strong> ?</p>
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-danger">ğŸ—‘ Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% for locataire in proprietaire.locataires.all %}
    <!-- Modal Modifier Locataire -->
    <div class="modal fade" id="modalModifierLocataire{{ locataire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">âœï¸ Modifier {{ locataire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'modifier_locataire' locataire.id %}">
              {% csrf_token %}
              {{ locataire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">âœ… Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Supprimer Locataire -->
    <div class="modal fade" id="modalSupprimerLocataire{{ locataire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">ğŸ—‘ Supprimer {{ locataire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'supprimer_locataire' locataire.id %}">
              {% csrf_token %}
              <p>Confirmer la suppression de <strong>{{ locataire.nom }}</strong> ?</p>
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-danger">ğŸ—‘ Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endfor %}
</div>



<script>
document.addEventListener("DOMContentLoaded", function() {
    const btnFiltrer = document.getElementById("btn-filtrer");
    const proprietaireSelect = document.getElementById("id_proprietaire");
    const locataireSelect = document.getElementById("id_locataire");
    const montantField = document.getElementById("id_montant");

    // Bouton Filtrer : charge les locataires du propriÃ©taire choisi
    btnFiltrer.addEventListener("click", function() {
        const proprietaireId = proprietaireSelect.value;

        if (!proprietaireId || proprietaireId === "") {
            alert("Veuillez choisir un propriÃ©taire !");
            return;
        }

        fetch(`/get-locataires/${proprietaireId}/`)
          .then(response => response.json())
          .then(data => {
              locataireSelect.innerHTML = ""; // vider la liste

              if (data.locataires.length === 0) {
                  const option = document.createElement("option");
                  option.value = "";
                  option.textContent = "Aucun locataire trouvÃ©";
                  locataireSelect.appendChild(option);
              } else {
                  data.locataires.forEach(locataire => {
                      const option = document.createElement("option");
                      option.value = locataire.id;
                      option.textContent = locataire.nom;
                      locataireSelect.appendChild(option);
                  });
              }
          })
          .catch(error => console.error("Erreur fetch locataires :", error));
    });

    // Quand on choisit un locataire, remplir automatiquement le montant
    locataireSelect.addEventListener("change", function() {
        const locataireId = this.value;
        if (!locataireId) return;

        fetch(`/get-loyer/${locataireId}/`)
          .then(response => response.json())
          .then(data => {
              montantField.value = data.loyer || "";
          })
          .catch(err => console.error("Erreur fetch loyer :", err));
    });
});
</script>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>



</body>
</html>
