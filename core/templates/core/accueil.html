{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NIVAL IMPACT - Accueil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="container mt-4 bg-light">

    <!-- Titre principal -->
    <h1 class="mb-4">üè† Gestion Locative NIVAL IMPACT</h1>

    <!-- Boutons d'ajout -->
    <div class="mb-4">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProprietaire">‚ûï Ajouter un propri√©taire</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLocataire">‚ûï Ajouter un locataire</button>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPaiement">üí∞ Enregistrer un paiement</button>
    </div>

    <!-- Modal Ajouter Propri√©taire -->
    <div class="modal fade" id="modalProprietaire" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">‚ûï Ajouter un propri√©taire</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'ajouter_proprietaire' %}">
              {% csrf_token %}
              {{ proprietaire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-success">‚úÖ Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Ajouter Locataire -->
    <div class="modal fade" id="modalLocataire" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">‚ûï Ajouter un locataire</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'ajouter_locataire' %}">
              {% csrf_token %}
              {{ locataire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

  <!-- Modal Ajouter Paiement -->
<div class="modal fade" id="modalPaiement" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">üí∞ Enregistrer un paiement</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form method="post" action="{% url 'ajouter_paiement' %}">
          {% csrf_token %}

          <!-- Propri√©taire -->
          <div class="mb-3">
            <label for="id_proprietaire" class="form-label">Propri√©taire</label>
            <select id="id_proprietaire" name="proprietaire" class="form-select">
  <option value="">-- S√©lectionnez un propri√©taire --</option>
  {% for proprietaire in proprietaires %}
    <option value="{{ proprietaire.id }}">{{ proprietaire.nom }}</option>
  {% endfor %}
</select>

          </div>

          <!-- Locataire -->
          <div class="mb-3">
            <label for="id_locataire" class="form-label">Locataire</label>
           <select id="id_locataire" name="locataire" class="form-select">
  <option value="">-- S√©lectionnez un locataire --</option>
</select>

          </div>

          <!-- Montant -->
          <div class="mb-3">
            <label for="id_montant" class="form-label">Montant</label>
            {{ paiement_form.montant }}
          </div>

          <!-- Date de paiement -->
          <div class="mb-3">
            <label for="id_date_paiement" class="form-label">Date de paiement</label>
            {{ paiement_form.date_paiement }}
          </div>

          <!-- Mois concern√© -->
          <div class="mb-3">
            <label for="id_mois_concerne" class="form-label">Mois concern√©</label>
            {{ paiement_form.mois_concerne }}
          </div>

          <!-- Pay√© en avance -->
          <div class="form-check mb-3">
            {{ paiement_form.paye_en_avance }}
            <label class="form-check-label" for="id_paye_en_avance">Pay√© en avance</label>
          </div>

          <div class="mt-3 text-end">
            <button type="submit" class="btn btn-warning">‚úÖ Enregistrer</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>




    <!-- Script pour pr√©-remplir le montant -->
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const loyers = {{ loyers_dict|safe }};
        const selectLocataire = document.getElementById("id_locataire");
        const montantField = document.getElementById("id_montant");

        if (selectLocataire && montantField) {
          selectLocataire.addEventListener("change", function() {
            const locataireId = this.value;  // valeur en string
            if (loyers[locataireId]) {
              montantField.value = loyers[locataireId];
            } else {
              montantField.value = "";
            }
          });
        }
      });
    </script>

    <!-- Filtre par mois -->
    <form method="get" class="mb-4">
        <label for="mois">Filtrer par mois :</label>
        <select name="mois" id="mois" class="form-select w-auto d-inline-block">
            <option value="">Tous</option>
            {% for i in mois_list %}
                <option value="{{ i }}" {% if mois == i|stringformat:"s" %}selected{% endif %}>{{ i }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">Filtrer</button>
    </form>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-2"><strong>Propri√©taires :</strong> {{ proprietaires_count }}</div>
        <div class="col-md-2"><strong>Locataires :</strong> {{ locataires_count }}</div>
        <div class="col-md-3"><strong>Loyers totaux :</strong> {{ total_loyers }} FCFA</div>
        <div class="col-md-3"><strong>Loyers re√ßus :</strong> {{ total_recu }} FCFA</div>
        <div class="col-md-2"><strong>Commission :</strong> {{ commission }} FCFA</div>
    </div>

   

    
    <!-- Cartes des propri√©taires -->
<div class="row">
    {% for proprietaire in proprietaires %}
    <div class="col-md-4 mb-3">
        <div class="card shadow">
            <div class="card-body">
                <h5 class="card-title">{{ proprietaire.nom }}</h5>
                <p class="card-text">üìû {{ proprietaire.numero }}</p>

                <!-- Boutons d'action -->
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierProprietaire{{ proprietaire.id }}">‚úèÔ∏è Modifier</button>
                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerProprietaire{{ proprietaire.id }}">üóë Supprimer</button>

                <button class="btn btn-outline-primary mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#locataires{{ proprietaire.id }}">
                    Voir les locataires
                </button>
                <div class="collapse mt-2" id="locataires{{ proprietaire.id }}">
                    <ul class="list-group">
                        {% for locataire in proprietaire.locataire_set.all %}
                            <li class="list-group-item">
                                {{ locataire.nom }} - {{ locataire.numero }} - {{ locataire.loyer_mensuel }} FCFA
                                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#modalModifierLocataire{{ locataire.id }}">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalSupprimerLocataire{{ locataire.id }}">üóë</button>
                            </li>
                        {% empty %}
                            <li class="list-group-item">Aucun locataire</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Modifier Propri√©taire -->
    <div class="modal fade" id="modalModifierProprietaire{{ proprietaire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">‚úèÔ∏è Modifier {{ proprietaire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'modifier_proprietaire' proprietaire.id %}">
              {% csrf_token %}
              {{ proprietaire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Supprimer Propri√©taire -->
    <div class="modal fade" id="modalSupprimerProprietaire{{ proprietaire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">üóë Supprimer {{ proprietaire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'supprimer_proprietaire' proprietaire.id %}">
              {% csrf_token %}
              <p>Confirmer la suppression de <strong>{{ proprietaire.nom }}</strong> ?</p>
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-danger">üóë Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    {% for locataire in proprietaire.locataire_set.all %}
    <!-- Modal Modifier Locataire -->
    <div class="modal fade" id="modalModifierLocataire{{ locataire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">‚úèÔ∏è Modifier {{ locataire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'modifier_locataire' locataire.id %}">
              {% csrf_token %}
              {{ locataire_form.as_p }}
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Supprimer Locataire -->
    <div class="modal fade" id="modalSupprimerLocataire{{ locataire.id }}" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title">üóë Supprimer {{ locataire.nom }}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form method="post" action="{% url 'supprimer_locataire' locataire.id %}">
              {% csrf_token %}
              <p>Confirmer la suppression de <strong>{{ locataire.nom }}</strong> ?</p>
              <div class="mt-3 text-end">
                <button type="submit" class="btn btn-danger">üóë Supprimer</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
    {% endfor %}
</div>

<!-- Liste des locataires impay√©s -->
    <h3 class="mt-4">üìå Locataires qui n'ont pas pay√© {% if mois %}pour le mois {{ mois }}{% endif %}</h3>
    <ul class="list-group">
        {% for item in locataires_non_payes %}
            <li class="list-group-item">
                <strong>Propri√©taire :</strong> {{ item.proprietaire.nom }}  
                ‚Üí <strong>Locataire :</strong> {{ item.locataire.nom }} (üìû {{ item.locataire.numero }})
            </li>
        {% empty %}
            <li class="list-group-item">‚úÖ Tous les locataires ont pay√© ce mois</li>
        {% endfor %}
    </ul>

    <!-- Scripts Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const proprietaireSelect = document.getElementById("id_proprietaire");
    const locataireSelect = document.getElementById("id_locataire");
    const montantField = document.getElementById("id_montant");

    // Quand on choisit un propri√©taire
    if (proprietaireSelect) {
        proprietaireSelect.addEventListener("change", function() {
            const proprietaireId = this.value;
            locataireSelect.innerHTML = '<option value="">-- S√©lectionnez un locataire --</option>';
            if (!proprietaireId) return;

            fetch(`/get-locataires/${proprietaireId}/`)
                .then(response => response.json())
                .then(locataires => {
                    locataires.forEach(l => {
                        const option = document.createElement("option");
                        option.value = l.id;
                        option.textContent = l.nom;
                        locataireSelect.appendChild(option);
                    });
                })
                .catch(err => console.error("Erreur fetch locataires :", err));
        });
    }

    // Quand on choisit un locataire
    if (locataireSelect) {
        locataireSelect.addEventListener("change", function() {
            const locataireId = this.value;
            if (!locataireId) return;

            fetch(`/get-loyer/${locataireId}/`)
                .then(response => response.json())
                .then(data => {
                    montantField.value = data.loyer || "";
                })
                .catch(err => console.error("Erreur fetch loyer :", err));
        });
    }
});
</script>






</body>
</html>
