{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>NIVAL IMPACT - Accueil</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="container mt-4 bg-light">

    <!-- Titre + D√©connexion -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>üè† Gestion Locative NIVAL IMPACT</h1>
        <div>
            <a href="{% url 'parametres' %}" class="btn btn-outline-secondary me-2">‚öôÔ∏è Param√®tres</a>
            <form method="post" action="{% url 'logout' %}" style="display:inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger">üö™ D√©connexion</button>
            </form>
        </div>
    </div>

    <!-- Boutons d'ajout -->
    <div class="mb-4 d-flex flex-wrap gap-2">
        <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalProprietaire">‚ûï Ajouter un propri√©taire</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalLocataire">‚ûï Ajouter un locataire</button>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalPaiement">üí∞ Enregistrer un paiement</button>
    </div>

    <!-- MODAL AJOUTER PROPRI√âTAIRE -->
    <div class="modal fade" id="modalProprietaire" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">‚ûï Ajouter un propri√©taire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'ajouter_proprietaire' %}">
                    {% csrf_token %}
                    {{ proprietaire_form.as_p }}
                    <div class="mt-3 text-end"><button type="submit" class="btn btn-success">‚úÖ Enregistrer</button></div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- MODAL AJOUTER LOCATAIRE -->
    <div class="modal fade" id="modalLocataire" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">‚ûï Ajouter un locataire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'ajouter_locataire' %}">
                    {% csrf_token %}
                    {{ locataire_form.as_p }}
                    <div class="mt-3 text-end"><button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button></div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- MODAL AJOUTER PAIEMENT -->
    <div class="modal fade" id="modalPaiement" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">üí∞ Enregistrer un paiement</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="paiementForm" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label>Propri√©taire</label>
                        <select name="proprietaire" id="select_proprietaire" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                            <option value="">--- S√©lectionnez un propri√©taire ---</option>
                            {% for proprietaire in proprietaires %}
                                <option value="{{ proprietaire.id }}">{{ proprietaire.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Locataire</label>
                        <select name="locataire" id="select_locataire" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                            <option value="">--- Choisissez d'abord un propri√©taire ---</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>Montant</label>
                        <input type="number" name="montant" id="input_montant" step="0.01" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                    </div>
                    <div class="mb-3">
                        <label>Date de paiement</label>
                        <input type="date" name="date_paiement" id="input_date" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                    </div>
                    <div class="mb-3">
                        <label>Mois concern√©</label>
                        <select name="mois_concerne" id="select_mois" required style="width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;">
                            <option value="">---</option>
                            <option value="1">Janvier</option><option value="2">F√©vrier</option>
                            <option value="3">Mars</option><option value="4">Avril</option>
                            <option value="5">Mai</option><option value="6">Juin</option>
                            <option value="7">Juillet</option><option value="8">Ao√ªt</option>
                            <option value="9">Septembre</option><option value="10">Octobre</option>
                            <option value="11">Novembre</option><option value="12">D√©cembre</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label><input type="checkbox" name="paye_en_avance" id="input_avance"> Pay√© en avance</label>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-warning">‚úÖ Enregistrer</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- MODAL MODIFIER PROPRI√âTAIRE (unique dynamique) -->
    <div class="modal fade" id="modalModifierProprietaire" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="titreModifierProp">‚úèÔ∏è Modifier le propri√©taire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="formModifierProprietaire" action="">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-control" id="edit_prop_nom" name="nom" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Num√©ro</label>
                        <input type="text" class="form-control" id="edit_prop_numero" name="numero" required>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- MODAL SUPPRIMER PROPRI√âTAIRE (unique dynamique) -->
    <div class="modal fade" id="modalSupprimerProprietaire" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üóë Supprimer le propri√©taire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="formSupprimerProprietaire" action="">
                    {% csrf_token %}
                    <p>Confirmer la suppression de <strong id="nomSupprimerProp"></strong> ?</p>
                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-danger">üóë Supprimer</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- MODAL MODIFIER LOCATAIRE (unique dynamique) -->
    <div class="modal fade" id="modalModifierLocataire" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="titreModifierLoc">‚úèÔ∏è Modifier le locataire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="formModifierLocataire" action="">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Nom</label>
                        <input type="text" class="form-control" id="edit_loc_nom" name="nom" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Num√©ro</label>
                        <input type="text" class="form-control" id="edit_loc_numero" name="numero" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Loyer mensuel</label>
                        <input type="number" step="0.01" class="form-control" id="edit_loc_loyer" name="loyer_mensuel" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Propri√©taire</label>
                        <select class="form-select" id="edit_loc_proprietaire" name="proprietaire" required>
                            {% for prop in proprietaires %}
                                <option value="{{ prop.id }}">{{ prop.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-primary">‚úÖ Enregistrer</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- MODAL SUPPRIMER LOCATAIRE (unique dynamique) -->
    <div class="modal fade" id="modalSupprimerLocataire" tabindex="-1">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">üóë Supprimer le locataire</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="formSupprimerLocataire" action="">
                    {% csrf_token %}
                    <p>Confirmer la suppression de <strong id="nomSupprimerLoc"></strong> ?</p>
                    <div class="mt-3 text-end">
                        <button type="submit" class="btn btn-danger">üóë Supprimer</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    </div>
                </form>
            </div>
        </div></div>
    </div>

    <!-- FILTRE MOIS / ANN√âE -->
    <form method="get" class="d-flex align-items-center gap-3 flex-wrap mb-3">
        <div>
            <label class="form-label mb-0 fw-semibold">Mois :</label>
            <select name="mois" class="form-select form-select-sm w-auto d-inline-block">
                <option value="">Tous</option>
                {% for i in mois_list %}
                    <option value="{{ i }}" {% if mois == i|stringformat:"s" %}selected{% endif %}>
                        {% if i == 1 %}Janvier{% elif i == 2 %}F√©vrier{% elif i == 3 %}Mars{% elif i == 4 %}Avril{% elif i == 5 %}Mai{% elif i == 6 %}Juin{% elif i == 7 %}Juillet{% elif i == 8 %}Ao√ªt{% elif i == 9 %}Septembre{% elif i == 10 %}Octobre{% elif i == 11 %}Novembre{% elif i == 12 %}D√©cembre{% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="form-label mb-0 fw-semibold">Ann√©e :</label>
            <select name="annee" class="form-select form-select-sm w-auto d-inline-block">
                <option value="">Toutes</option>
                {% for a in annee_list %}
                    <option value="{{ a }}" {% if annee == a|stringformat:"s" %}selected{% endif %}>{{ a }}</option>
                {% endfor %}
            </select>
        </div>
        <button type="submit" class="btn btn-primary btn-sm">üîç Filtrer</button>
        <a href="{% url 'accueil' %}" class="btn btn-outline-secondary btn-sm">‚úñ R√©initialiser</a>
    </form>

    <!-- STATISTIQUES -->
    <div class="row mb-4">
        <div class="col-md-3"><strong>Propri√©taires :</strong> {{ proprietaires_count }}</div>
        <div class="col-md-3"><strong>Locataires :</strong> {{ locataires_count }}</div>
        <div class="col-md-3"><strong>Loyers re√ßus :</strong> {{ total_recu }} FCFA</div>
        <div class="col-md-3"><strong>Commission :</strong> {{ commission }} FCFA</div>
    </div>

    <!-- BOUTONS NAVIGATION -->
    <div class="mb-3 d-flex flex-wrap gap-2">
        <button class="btn btn-danger" type="button" data-bs-toggle="collapse" data-bs-target="#nonPayesList">
            üìå Locataires non pay√©s ({{ non_payes_count }})
        </button>
        <a href="{% url 'liste_paiements' %}" class="btn btn-info">üí∞ Voir les paiements</a>
        <a href="{% url 'rapport_global' %}" class="btn btn-primary">üìä Rapport global</a>
        <a href="{% url 'rapport_global_pdf' %}" class="btn btn-danger">üìÑ Rapport global PDF</a>
    </div>

    <!-- LISTE NON PAY√âS -->
    <div class="collapse mb-4" id="nonPayesList">
        <h5>Locataires qui n'ont pas pay√© {% if mois %}pour le mois {{ mois }}{% endif %}</h5>
        <ul class="list-group">
            {% for item in locataires_non_payes %}
            <li class="list-group-item">
                <strong>Propri√©taire :</strong> {{ item.proprietaire.nom }}
                ‚Üí <strong>Locataire :</strong> {{ item.locataire.nom }} (üìû {{ item.locataire.numero }})
            </li>
            {% empty %}
            <li class="list-group-item">‚úÖ Tous les locataires ont pay√© ce mois</li>
            {% endfor %}
        </ul>
    </div>

    <!-- CARTES PROPRI√âTAIRES -->
    <div class="row mt-2">
        {% for proprietaire in proprietaires %}
        <div class="col-md-4 mb-3">
            <div class="card shadow">
                <div class="card-body">
                    <h5 class="card-title">{{ proprietaire.nom }}</h5>
                    <p class="card-text">üìû {{ proprietaire.numero }}</p>

                    <button class="btn btn-sm btn-primary"
                        data-bs-toggle="modal" data-bs-target="#modalModifierProprietaire"
                        data-id="{{ proprietaire.id }}"
                        data-nom="{{ proprietaire.nom }}"
                        data-numero="{{ proprietaire.numero }}">‚úèÔ∏è Modifier</button>

                    <button class="btn btn-sm btn-danger"
                        data-bs-toggle="modal" data-bs-target="#modalSupprimerProprietaire"
                        data-id="{{ proprietaire.id }}"
                        data-nom="{{ proprietaire.nom }}">üóë Supprimer</button>

                    <button class="btn btn-outline-primary mt-2" type="button"
                        data-bs-toggle="collapse" data-bs-target="#locataires{{ proprietaire.id }}">
                        Voir les locataires
                    </button>

                    <a href="{% url 'rapport_proprietaire' proprietaire.id %}" class="btn btn-outline-warning mt-2">üìä Rapport mensuel</a>
                    <a href="{% url 'rapport_proprietaire_pdf' proprietaire.id %}" class="btn btn-outline-danger mt-2">üìÑ T√©l√©charger en PDF</a>

                    <!-- Liste locataires -->
                    <div class="collapse mt-2" id="locataires{{ proprietaire.id }}">
                        <ul class="list-group">
                            {% for locataire in proprietaire.locataires.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <span>{{ locataire.nom }} - {{ locataire.numero }} - {{ locataire.loyer_mensuel }} FCFA</span>
                                <span>
                                    <button class="btn btn-sm btn-primary"
                                        data-bs-toggle="modal" data-bs-target="#modalModifierLocataire"
                                        data-id="{{ locataire.id }}"
                                        data-nom="{{ locataire.nom }}"
                                        data-numero="{{ locataire.numero }}"
                                        data-loyer="{{ locataire.loyer_mensuel }}"
                                        data-proprietaire="{{ locataire.proprietaire.id }}">‚úèÔ∏è</button>
                                    <button class="btn btn-sm btn-danger"
                                        data-bs-toggle="modal" data-bs-target="#modalSupprimerLocataire"
                                        data-id="{{ locataire.id }}"
                                        data-nom="{{ locataire.nom }}">üóë</button>
                                </span>
                            </li>
                            {% empty %}
                            <li class="list-group-item">Aucun locataire</li>
                            {% endfor %}
                        </ul>
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {

        // PAIEMENT
        const form = document.getElementById("paiementForm");
        const propSelect = document.getElementById("select_proprietaire");
        const locSelect = document.getElementById("select_locataire");
        const montantInput = document.getElementById("input_montant");

        function chargerLocataires(proprietaireId) {
            if (!proprietaireId) {
                locSelect.innerHTML = '<option value="">--- Choisissez d\'abord un propri√©taire ---</option>';
                return;
            }
            fetch(`/get-locataires/${proprietaireId}/`)
                .then(r => r.json())
                .then(data => {
                    locSelect.innerHTML = '<option value="">--- S√©lectionnez un locataire ---</option>';
                    data.locataires.forEach(loc => {
                        locSelect.innerHTML += `<option value="${loc.id}">${loc.nom}</option>`;
                    });
                });
        }

        propSelect.onchange = function () { chargerLocataires(this.value); };

        locSelect.onchange = function () {
            if (!this.value) return;
            fetch(`/get-loyer/${this.value}/`)
                .then(r => r.json())
                .then(data => { montantInput.value = data.loyer || ""; });
        };

        form.onsubmit = function (e) {
            e.preventDefault();
            fetch("{% url 'ajouter_paiement' %}", {
                method: "POST",
                body: new FormData(form),
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(r => r.json().then(data => ({ status: r.status, data })))
            .then(({ status, data }) => {
                if (status === 200 && data.success) {
                    alert("‚úÖ Paiement enregistr√© avec succ√®s !");
                    chargerLocataires(propSelect.value);
                    montantInput.value = "";
                } else {
                    alert(data.errors?.__all__?.[0] || "‚ùå Erreur lors de l'enregistrement");
                }
            });
        };

        // MODIFIER PROPRI√âTAIRE
        document.getElementById('modalModifierProprietaire').addEventListener('show.bs.modal', function (event) {
            var btn = event.relatedTarget;
            document.getElementById('edit_prop_nom').value = btn.getAttribute('data-nom');
            document.getElementById('edit_prop_numero').value = btn.getAttribute('data-numero');
            document.getElementById('titreModifierProp').textContent = '‚úèÔ∏è Modifier ' + btn.getAttribute('data-nom');
            document.getElementById('formModifierProprietaire').action = `/proprietaire/modifier/${btn.getAttribute('data-id')}/`;
        });

        // SUPPRIMER PROPRI√âTAIRE
        document.getElementById('modalSupprimerProprietaire').addEventListener('show.bs.modal', function (event) {
            var btn = event.relatedTarget;
            document.getElementById('nomSupprimerProp').textContent = btn.getAttribute('data-nom');
            document.getElementById('formSupprimerProprietaire').action = `/proprietaire/supprimer/${btn.getAttribute('data-id')}/`;
        });

        // MODIFIER LOCATAIRE
        document.getElementById('modalModifierLocataire').addEventListener('show.bs.modal', function (event) {
            var btn = event.relatedTarget;
            var loyer = btn.getAttribute('data-loyer').replace(',', '.');
            document.getElementById('edit_loc_nom').value = btn.getAttribute('data-nom');
            document.getElementById('edit_loc_numero').value = btn.getAttribute('data-numero');
            document.getElementById('edit_loc_loyer').value = loyer;
            document.getElementById('edit_loc_proprietaire').value = btn.getAttribute('data-proprietaire');
            document.getElementById('titreModifierLoc').textContent = '‚úèÔ∏è Modifier ' + btn.getAttribute('data-nom');
            document.getElementById('formModifierLocataire').action = `/locataire/modifier/${btn.getAttribute('data-id')}/`;
        });

        // SUPPRIMER LOCATAIRE
        document.getElementById('modalSupprimerLocataire').addEventListener('show.bs.modal', function (event) {
            var btn = event.relatedTarget;
            document.getElementById('nomSupprimerLoc').textContent = btn.getAttribute('data-nom');
            document.getElementById('formSupprimerLocataire').action = `/locataire/supprimer/${btn.getAttribute('data-id')}/`;
        });

    });
    </script>

</body>
</html>